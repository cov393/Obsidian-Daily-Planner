import { __awaiter } from "tslib";
import { Notice, TFile } from "obsidian";
import { ensureFoldersExist } from "../utils/utils";
import { PassThrough } from "stream";
export class SelfDevManager {
    constructor(app, settings) {
        this.app = app;
        this.settings = settings;
    }
    // GET the folder name by year
    getFileNameByYear(date) {
        const yearDate = date.toLocaleDateString("en-GB", { year: "numeric" });
        return `${yearDate} Year`;
    }
    // Get the folder name by month
    getFileNameByMonth(date) {
        const monthData = date.toLocaleDateString("en-GB", { month: "long" });
        return `ðŸ“… ${monthData}`;
    }
    // Getting the file name by date
    getFileNameByDate(date) {
        const dateStr = date.toLocaleDateString("en-GB", { day: "numeric", month: "long" });
        return `ðŸ“… ${dateStr}.md`;
    }
    // }
    getFilePathByDate(date) {
        return `${this.settings.mainFileDirectory}/${this.settings.taskFileDirectory}/${this.getFileNameByYear(date)}/${this.getFileNameByMonth(date)}/${this.getFileNameByDate(date)}`;
    }
    // Creating a new task file for today if it hasn't been created yet
    createDailyFile() {
        return __awaiter(this, void 0, void 0, function* () {
            const filePath = this.getFilePathByDate(new Date());
            yield ensureFoldersExist(this.app, filePath);
            let file = this.app.vault.getAbstractFileByPath(filePath);
            if (!file) {
                file = yield this.app.vault.create(filePath, `# âœ…Tasks - ${new Date().toLocaleDateString("en-GB")}\n\n`);
                new Notice(`Fail "${file.name}" created!`);
            }
            else {
                PassThrough;
            }
        });
    }
    // Retrieve incomplete tasks for today
    getTodayTasks() {
        return __awaiter(this, void 0, void 0, function* () {
            const filePath = this.getFilePathByDate(new Date());
            const file = this.app.vault.getAbstractFileByPath(filePath);
            if (file instanceof TFile) {
                const content = yield this.app.vault.read(file);
                return content
                    .split('\n')
                    .filter(line => line.trim().startsWith('- [') && !line.trim().startsWith('- [x]'))
                    .map(line => line.trim());
            }
            return [];
        });
    }
    // Add a task to today's file
    appendTask(taskText) {
        return __awaiter(this, void 0, void 0, function* () {
            const filePath = this.getFilePathByDate(new Date());
            const file = this.app.vault.getAbstractFileByPath(filePath);
            if (file instanceof TFile) {
                yield this.app.vault.append(file, `- [ ] ${taskText}\n`);
            }
            else {
                // If the file doesn't exist - create it and add the task
                yield this.createDailyFile();
                const newFile = this.app.vault.getAbstractFileByPath(filePath);
                yield this.app.vault.append(newFile, `- [ ] ${taskText}\n`);
            }
        });
    }
    // Transfer incomplete tasks from yesterday to today
    migrateUnfinishedTasks() {
        return __awaiter(this, void 0, void 0, function* () {
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            const yesterdayFilePath = this.getFilePathByDate(yesterday);
            const todayFilePath = this.getFilePathByDate(today);
            const yesterdayFile = this.app.vault.getAbstractFileByPath(yesterdayFilePath);
            const todayFile = this.app.vault.getAbstractFileByPath(todayFilePath);
            if (!(yesterdayFile instanceof TFile)) {
                new Notice("File from yesterday doesn't exists.");
                return;
            }
            const content = yield this.app.vault.read(yesterdayFile);
            const unfinishedTasks = content
                .split('\n')
                .filter(line => line.trim().startsWith('- [') && !line.trim().startsWith('- [x]'))
                .map(line => line.trim());
            if (unfinishedTasks.length === 0) {
                new Notice("There are no unfinished tasks to transfer.");
                return;
            }
            if (!(todayFile instanceof TFile)) {
                yield this.createDailyFile();
            }
            const file = this.app.vault.getAbstractFileByPath(todayFilePath);
            yield this.app.vault.append(file, unfinishedTasks.join('\n') + '\n');
            new Notice(`Transfared ${unfinishedTasks.length} tasks from file ${this.getFileNameByDate(yesterday)}!`);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZkRldk1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbW9kZWxzL3NlbGZEZXZNb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFPLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDOUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUdyQyxNQUFNLE9BQU8sY0FBYztJQU92QixZQUFZLEdBQVEsRUFBRSxRQUFrRTtRQUNwRixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzdCLENBQUM7SUFFRCw4QkFBOEI7SUFDdEIsaUJBQWlCLENBQUUsSUFBVTtRQUNqQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLEVBQUMsSUFBSSxFQUFFLFNBQVMsRUFBQyxDQUFDLENBQUE7UUFDcEUsT0FBTyxHQUFHLFFBQVEsT0FBTyxDQUFBO0lBQzdCLENBQUM7SUFFRCwrQkFBK0I7SUFDdkIsa0JBQWtCLENBQUMsSUFBVTtRQUNqQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDdEUsT0FBTyxNQUFNLFNBQVMsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFRCxnQ0FBZ0M7SUFDeEIsaUJBQWlCLENBQUMsSUFBVTtRQUNoQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQztRQUNuRixPQUFPLE1BQU0sT0FBTyxLQUFLLENBQUM7SUFDOUIsQ0FB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QUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUU5QixJQUFJLGVBQWUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUM5QixJQUFJLE1BQU0sQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO2dCQUN6RCxPQUFPO2FBQ1Y7WUFFRCxJQUFJLENBQUMsQ0FBQyxTQUFTLFlBQVksS0FBSyxDQUFDLEVBQUU7Z0JBQy9CLE1BQU0sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2FBQ2hDO1lBRUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsYUFBYSxDQUFVLENBQUM7WUFDMUUsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFDckUsSUFBSSxNQUFNLENBQUMsY0FBYyxlQUFlLENBQUMsTUFBTSxvQkFBb0IsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3RyxDQUFDO0tBQUE7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcCwgTm90aWNlLCBURmlsZSB9IGZyb20gXCJvYnNpZGlhblwiO1xyXG5pbXBvcnQgeyBlbnN1cmVGb2xkZXJzRXhpc3QgfSBmcm9tIFwiLi4vdXRpbHMvdXRpbHNcIjtcclxuaW1wb3J0IHsgUGFzc1Rocm91Z2ggfSBmcm9tIFwic3RyZWFtXCI7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFNlbGZEZXZNYW5hZ2VyIHtcclxuICAgIHByaXZhdGUgYXBwOiBBcHA7XHJcbiAgICBwcml2YXRlIHNldHRpbmdzOiB7XHJcbiAgICAgICAgbWFpbkZpbGVEaXJlY3Rvcnk6IHN0cmluZztcclxuICAgICAgICB0YXNrRmlsZURpcmVjdG9yeTogc3RyaW5nO1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihhcHA6IEFwcCwgc2V0dGluZ3M6IHsgbWFpbkZpbGVEaXJlY3Rvcnk6IHN0cmluZzsgdGFza0ZpbGVEaXJlY3Rvcnk6IHN0cmluZyB9KSB7XHJcbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XHJcbiAgICAgICAgdGhpcy5zZXR0aW5ncyA9IHNldHRpbmdzO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEdFVCB0aGUgZm9sZGVyIG5hbWUgYnkgeWVhclxyXG4gICAgcHJpdmF0ZSBnZXRGaWxlTmFtZUJ5WWVhciAoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3QgeWVhckRhdGUgPSBkYXRlLnRvTG9jYWxlRGF0ZVN0cmluZyhcImVuLUdCXCIsIHt5ZWFyOiBcIm51bWVyaWNcIn0pXHJcbiAgICAgICAgcmV0dXJuIGAke3llYXJEYXRlfSBZZWFyYFxyXG4gICAgfVxyXG5cclxuICAgIC8vIEdldCB0aGUgZm9sZGVyIG5hbWUgYnkgbW9udGhcclxuICAgIHByaXZhdGUgZ2V0RmlsZU5hbWVCeU1vbnRoKGRhdGU6IERhdGUpOiBzdHJpbmcge1xyXG4gICAgICAgIGNvbnN0IG1vbnRoRGF0YSA9IGRhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKFwiZW4tR0JcIiwgeyBtb250aDogXCJsb25nXCIgfSk7XHJcbiAgICAgICAgcmV0dXJuIGDwn5OFICR7bW9udGhEYXRhfWA7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gR2V0dGluZyB0aGUgZmlsZSBuYW1lIGJ5IGRhdGVcclxuICAgIHByaXZhdGUgZ2V0RmlsZU5hbWVCeURhdGUoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3QgZGF0ZVN0ciA9IGRhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKFwiZW4tR0JcIiwgeyBkYXk6IFwibnVtZXJpY1wiLCBtb250aDogXCJsb25nXCJ9KTtcclxuICAgICAgICByZXR1cm4gYPCfk4UgJHtkYXRlU3RyfS5tZGA7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gfVxyXG4gICAgcHVibGljIGdldEZpbGVQYXRoQnlEYXRlKGRhdGU6IERhdGUpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBgJHt0aGlzLnNldHRpbmdzLm1haW5GaWxlRGlyZWN0b3J5fS8ke3RoaXMuc2V0dGluZ3MudGFza0ZpbGVEaXJlY3Rvcnl9LyR7dGhpcy5nZXRGaWxlTmFtZUJ5WWVhcihkYXRlKX0vJHt0aGlzLmdldEZpbGVOYW1lQnlNb250aChkYXRlKX0vJHt0aGlzLmdldEZpbGVOYW1lQnlEYXRlKGRhdGUpfWA7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ3JlYXRpbmcgYSBuZXcgdGFzayBmaWxlIGZvciB0b2RheSBpZiBpdCBoYXNuJ3QgYmVlbiBjcmVhdGVkIHlldFxyXG4gICAgYXN5bmMgY3JlYXRlRGFpbHlGaWxlKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5nZXRGaWxlUGF0aEJ5RGF0ZShuZXcgRGF0ZSgpKTtcclxuICAgICAgICBhd2FpdCBlbnN1cmVGb2xkZXJzRXhpc3QodGhpcy5hcHAsIGZpbGVQYXRoKTtcclxuICAgICAgICBsZXQgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmaWxlUGF0aCkgYXMgVEZpbGUgfCBudWxsO1xyXG5cclxuICAgICAgICBpZiAoIWZpbGUpIHtcclxuICAgICAgICAgICAgZmlsZSA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZShmaWxlUGF0aCwgYCMg4pyFVGFza3MgLSAke25ldyBEYXRlKCkudG9Mb2NhbGVEYXRlU3RyaW5nKFwiZW4tR0JcIil9XFxuXFxuYCk7XHJcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoYEZhaWwgXCIke2ZpbGUubmFtZX1cIiBjcmVhdGVkIWApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIFBhc3NUaHJvdWdoXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFJldHJpZXZlIGluY29tcGxldGUgdGFza3MgZm9yIHRvZGF5XHJcbiAgICBhc3luYyBnZXRUb2RheVRhc2tzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcclxuICAgICAgICBjb25zdCBmaWxlUGF0aCA9IHRoaXMuZ2V0RmlsZVBhdGhCeURhdGUobmV3IERhdGUoKSk7XHJcbiAgICAgICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmaWxlUGF0aCkgYXMgVEZpbGUgfCBudWxsO1xyXG5cclxuICAgICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkKGZpbGUpO1xyXG4gICAgICAgICAgICByZXR1cm4gY29udGVudFxyXG4gICAgICAgICAgICAgICAgLnNwbGl0KCdcXG4nKVxyXG4gICAgICAgICAgICAgICAgLmZpbHRlcihsaW5lID0+IGxpbmUudHJpbSgpLnN0YXJ0c1dpdGgoJy0gWycpICYmICFsaW5lLnRyaW0oKS5zdGFydHNXaXRoKCctIFt4XScpKVxyXG4gICAgICAgICAgICAgICAgLm1hcChsaW5lID0+IGxpbmUudHJpbSgpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBBZGQgYSB0YXNrIHRvIHRvZGF5J3MgZmlsZVxyXG4gICAgYXN5bmMgYXBwZW5kVGFzayh0YXNrVGV4dDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSB0aGlzLmdldEZpbGVQYXRoQnlEYXRlKG5ldyBEYXRlKCkpO1xyXG4gICAgICAgIGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZmlsZVBhdGgpIGFzIFRGaWxlIHwgbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkge1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5hcHBlbmQoZmlsZSwgYC0gWyBdICR7dGFza1RleHR9XFxuYCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gSWYgdGhlIGZpbGUgZG9lc24ndCBleGlzdCAtIGNyZWF0ZSBpdCBhbmQgYWRkIHRoZSB0YXNrXHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY3JlYXRlRGFpbHlGaWxlKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld0ZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZmlsZVBhdGgpIGFzIFRGaWxlO1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5hcHBlbmQobmV3RmlsZSwgYC0gWyBdICR7dGFza1RleHR9XFxuYCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFRyYW5zZmVyIGluY29tcGxldGUgdGFza3MgZnJvbSB5ZXN0ZXJkYXkgdG8gdG9kYXlcclxuICAgIGFzeW5jIG1pZ3JhdGVVbmZpbmlzaGVkVGFza3MoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgY29uc3QgdG9kYXkgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIGNvbnN0IHllc3RlcmRheSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgeWVzdGVyZGF5LnNldERhdGUodG9kYXkuZ2V0RGF0ZSgpIC0gMSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHllc3RlcmRheUZpbGVQYXRoID0gdGhpcy5nZXRGaWxlUGF0aEJ5RGF0ZSh5ZXN0ZXJkYXkpO1xyXG4gICAgICAgIGNvbnN0IHRvZGF5RmlsZVBhdGggPSB0aGlzLmdldEZpbGVQYXRoQnlEYXRlKHRvZGF5KTtcclxuXHJcbiAgICAgICAgY29uc3QgeWVzdGVyZGF5RmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aCh5ZXN0ZXJkYXlGaWxlUGF0aCkgYXMgVEZpbGUgfCBudWxsO1xyXG4gICAgICAgIGNvbnN0IHRvZGF5RmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aCh0b2RheUZpbGVQYXRoKSBhcyBURmlsZSB8IG51bGw7XHJcblxyXG4gICAgICAgIGlmICghKHllc3RlcmRheUZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHtcclxuICAgICAgICAgICAgbmV3IE5vdGljZShcIkZpbGUgZnJvbSB5ZXN0ZXJkYXkgZG9lc24ndCBleGlzdHMuXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgdGhpcy5hcHAudmF1bHQucmVhZCh5ZXN0ZXJkYXlGaWxlKTtcclxuICAgICAgICBjb25zdCB1bmZpbmlzaGVkVGFza3MgPSBjb250ZW50XHJcbiAgICAgICAgICAgIC5zcGxpdCgnXFxuJylcclxuICAgICAgICAgICAgLmZpbHRlcihsaW5lID0+IGxpbmUudHJpbSgpLnN0YXJ0c1dpdGgoJy0gWycpICYmICFsaW5lLnRyaW0oKS5zdGFydHNXaXRoKCctIFt4XScpKVxyXG4gICAgICAgICAgICAubWFwKGxpbmUgPT4gbGluZS50cmltKCkpO1xyXG5cclxuICAgICAgICBpZiAodW5maW5pc2hlZFRhc2tzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICBuZXcgTm90aWNlKFwiVGhlcmUgYXJlIG5vIHVuZmluaXNoZWQgdGFza3MgdG8gdHJhbnNmZXIuXCIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoISh0b2RheUZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy5jcmVhdGVEYWlseUZpbGUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgodG9kYXlGaWxlUGF0aCkgYXMgVEZpbGU7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQuYXBwZW5kKGZpbGUsIHVuZmluaXNoZWRUYXNrcy5qb2luKCdcXG4nKSArICdcXG4nKTtcclxuICAgICAgICBuZXcgTm90aWNlKGBUcmFuc2ZhcmVkICR7dW5maW5pc2hlZFRhc2tzLmxlbmd0aH0gdGFza3MgZnJvbSBmaWxlICR7dGhpcy5nZXRGaWxlTmFtZUJ5RGF0ZSh5ZXN0ZXJkYXkpfSFgKTtcclxuICAgIH1cclxufVxyXG4iXX0=