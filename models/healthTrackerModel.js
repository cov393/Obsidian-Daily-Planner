import { __awaiter } from "tslib";
import { Notice } from "obsidian";
import { ensureFoldersExist } from "../utils/utils";
export class HealthTrackerManager {
    constructor(app, settings) {
        //Default list of muscle groups (used only if there is no previous table)
        this.defaultMuscleGroups = ["Glutes", "Legs", "Back", "Brists", "Shoulders", "Jogging", "Yoga"];
        this.app = app;
        this.settings = settings;
    }
    // Get the folder name by month
    getFileNameByMonth(date) {
        const monthData = date.toLocaleDateString("en-GB", { month: "long" });
        return `📅 ${monthData}`;
    }
    // Get the file name by week
    getFileNameByWeek(date) {
        const startOfWeek = this.getStartOfWeek(date);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        const startDate = startOfWeek.getDate();
        const endDate = endOfWeek.getDate();
        const startMonth = startOfWeek.toLocaleDateString("en-GB", { month: "short" });
        const endMonth = endOfWeek.toLocaleDateString("en-GB", { month: "short" });
        return startMonth === endMonth
            ? `${startDate} - ${endDate}.md`
            : `${startDate} ${startMonth} - ${endDate} ${endMonth}.md`;
    }
    // Get the full file path by date
    getFilePathByDate(date) {
        return `${this.settings.mainFileDirectory}/${this.settings.healthTrackerFileDirectory}/${this.getFileNameByMonth(date)}/${this.getFileNameByWeek(date)}`;
    }
    // Calculate the start of the week (Monday)
    getStartOfWeek(date) {
        const startOfWeek = new Date(date);
        const day = startOfWeek.getDay(); // Sunday = 0, Monday = 1, ...
        const offset = day === 0 ? 6 : day - 1; // Adjust for Monday start
        startOfWeek.setDate(startOfWeek.getDate() - offset);
        startOfWeek.setHours(0, 0, 0, 0); // Reset time to midnight
        return startOfWeek;
    }
    // Ensure all parent folders exist
    ensureFoldersExist(filePath) {
        return __awaiter(this, void 0, void 0, function* () {
            const folderPath = filePath.substring(0, filePath.lastIndexOf("/"));
            let folder = this.app.vault.getAbstractFileByPath(folderPath);
            if (!folder) {
                try {
                    yield this.app.vault.createFolder(folderPath);
                    new Notice(`Created folder: ${folderPath}`);
                }
                catch (error) {
                    console.error(`Failed to create folder ${folderPath}:`, error);
                    throw new Error(`Could not create folder ${folderPath}`);
                }
            }
        });
    }
    // New method: Extract muscle groups from the previous table
    getPreviousMuscleGroups(currentDate) {
        return __awaiter(this, void 0, void 0, function* () {
            const previousWeekStart = new Date(this.getStartOfWeek(currentDate));
            previousWeekStart.setDate(previousWeekStart.getDate() - 7); // Switch to the previous week
            const previousPath = this.getFilePathByDate(previousWeekStart);
            const previousFile = this.app.vault.getAbstractFileByPath(previousPath);
            if (!previousFile) {
                console.warn(`Previous week file not found: ${previousPath}. Using default muscle groups.`);
                return this.defaultMuscleGroups;
            }
            try {
                const content = yield this.app.vault.read(previousFile);
                const lines = content.split("\n");
                // Find the start of the table (after "Daily Habits Track"))
                const tableStart = lines.findIndex(line => line.includes("Daily Habits Track"));
                if (tableStart === -1) {
                    return this.defaultMuscleGroups; // Fallback if the table is corrupted
                }
                const muscleGroups = [];
                for (let i = tableStart + 1; i < lines.length && lines[i].startsWith("|"); i++) {
                    const cells = lines[i].split("|").map(cell => cell.trim());
                    if (cells.length < 2)
                        continue;
                    const group = cells[1];
                    if (group) {
                        muscleGroups.push(group); // Extract the muscle group from the second column
                    }
                }
                return muscleGroups.length > 0 ? muscleGroups : this.defaultMuscleGroups;
            }
            catch (error) {
                console.error(`Error parsing previous week file ${previousPath}:`, error);
                return this.defaultMuscleGroups; // Fallback to default
            }
        });
    }
    // Create a new weekly health tracker file if it doesn't exist
    createWeeklyFile() {
        return __awaiter(this, void 0, void 0, function* () {
            const today = new Date();
            const filePath = this.getFilePathByDate(today);
            yield ensureFoldersExist(this.app, filePath);
            let file = this.app.vault.getAbstractFileByPath(filePath);
            if (file) {
                return; // File already exists, do nothing
            }
            // Ensure parent folders exist
            yield this.ensureFoldersExist(filePath);
            const startOfWeek = this.getStartOfWeek(today);
            const daysOfWeek = ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"];
            const dates = [];
            // Collect dates and months for the week
            for (let i = 0; i < 7; i++) {
                const current = new Date(startOfWeek);
                current.setDate(startOfWeek.getDate() + i);
                dates.push({
                    day: current.getDate(),
                    month: current.toLocaleDateString("en-GB", { month: "short" }),
                });
            }
            // Obtain a dynamic list of muscle groups from the previous week
            const muscleGroups = yield this.getPreviousMuscleGroups(today);
            // Build table content
            let content = `# Health Tracker - ${today.toLocaleDateString("en-GB")}\n\n`;
            content += "| Weekdays           | " + daysOfWeek.join(" | ") + " |\n";
            content += "| ------------------ |" + " --- |".repeat(7) + "\n";
            content += "| Daily Habits Track | " + dates.map(d => `${d.day} ${d.month}`).join(" | ") + " |\n";
            // id Generator
            function generateId() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < 5; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }
            for (const group of muscleGroups) {
                content += `| ${group.padEnd(18)} | ` + daysOfWeek.map(() => `<input type="checkbox" unchecked id="${generateId()}">`).join(" | ") + " |\n";
            }
            try {
                file = yield this.app.vault.create(filePath, content);
                new Notice(`File "${file.name}" created!`);
            }
            catch (error) {
                console.error(`Failed to create file ${filePath}:`, error);
                new Notice(`Error creating file "${filePath}"`);
            }
        });
    }
    // Get summary of completed activities for the current week
    getThisWeekSummary() {
        return __awaiter(this, void 0, void 0, function* () {
            const filePath = this.getFilePathByDate(new Date());
            const file = this.app.vault.getAbstractFileByPath(filePath);
            const summary = [];
            if (!file) {
                return ["No health tracker file found for this week."];
            }
            try {
                const content = yield this.app.vault.read(file);
                const lines = content.split("\n");
                const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
                // Dynamically extract muscle groups from the current table (for summary statistics)
                const muscleGroups = yield this.getPreviousMuscleGroups(new Date()); // Or parse from the current file
                // Find the table start (after "Daily Habits Track")
                const tableStart = lines.findIndex(line => line.includes("Daily Habits Track"));
                if (tableStart === -1) {
                    return ["Table not found in file."];
                }
                // Parse muscle group rows
                for (let i = tableStart + 1; i < lines.length && lines[i].startsWith("|"); i++) {
                    const cells = lines[i].split("|").map(cell => cell.trim());
                    if (cells.length < 9)
                        continue; // Skip invalid rows
                    const group = cells[1];
                    if (!muscleGroups.includes(group.trim()))
                        continue;
                    // Check each day (columns 2 to 8)
                    for (let j = 2; j <= 8; j++) {
                        if (cells[j].includes("☑️")) {
                            summary.push(`${group.trim()} on ${daysOfWeek[j - 2]}`);
                        }
                    }
                }
                return summary.length > 0 ? summary : ["No completed activities this week."];
            }
            catch (error) {
                console.error(`Error reading file ${filePath}:`, error);
                return ["Error retrieving summary."];
            }
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVhbHRoVHJhY2tlck1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbW9kZWxzL2hlYWx0aFRyYWNrZXJNb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFPLE1BQU0sRUFBa0IsTUFBTSxVQUFVLENBQUM7QUFDdkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEQsTUFBTSxPQUFPLG9CQUFvQjtJQU83QixZQUFZLEdBQVEsRUFBRSxRQUEyRTtRQUtqRyx5RUFBeUU7UUFDakUsd0JBQW1CLEdBQUcsQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUwvRixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzdCLENBQUM7SUFLRCwrQkFBK0I7SUFDdkIsa0JBQWtCLENBQUMsSUFBVTtRQUNqQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDdEUsT0FBTyxNQUFNLFNBQVMsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFRCw0QkFBNEI7SUFDcEIsaUJBQWlCLENBQUMsSUFBVTtRQUNoQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlDLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3hDLFNBQVMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTdDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN4QyxNQUFNLE9BQU8sR0FB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SyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO29CQUMzRCxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQzt3QkFBRSxTQUFTLENBQUMsb0JBQW9CO29CQUVwRCxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3ZCLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQzt3QkFBRSxTQUFTO29CQUVuRCxrQ0FBa0M7b0JBQ2xDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7d0JBQ3pCLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTs0QkFDekIsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQzt5QkFDM0Q7cUJBQ0o7aUJBQ0o7Z0JBRUQsT0FBTyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7YUFDaEY7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDWixPQUFPLENBQUMsS0FBSyxDQUFDLHNCQUFzQixRQUFRLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDeEQsT0FBTyxDQUFDLDJCQUEyQixDQUFDLENBQUM7YUFDeEM7UUFDTCxDQUFDO0tBQUE7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcCwgTm90aWNlLCBURmlsZSwgVEZvbGRlciB9IGZyb20gXCJvYnNpZGlhblwiO1xyXG5pbXBvcnQgeyBlbnN1cmVGb2xkZXJzRXhpc3QgfSBmcm9tIFwiLi4vdXRpbHMvdXRpbHNcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBIZWFsdGhUcmFja2VyTWFuYWdlciB7XHJcbiAgICBwcml2YXRlIGFwcDogQXBwO1xyXG4gICAgcHJpdmF0ZSBzZXR0aW5nczoge1xyXG4gICAgICAgIG1haW5GaWxlRGlyZWN0b3J5OiBzdHJpbmc7XHJcbiAgICAgICAgaGVhbHRoVHJhY2tlckZpbGVEaXJlY3Rvcnk6IHN0cmluZztcclxuICAgIH07XHJcblxyXG4gICAgY29uc3RydWN0b3IoYXBwOiBBcHAsIHNldHRpbmdzOiB7IG1haW5GaWxlRGlyZWN0b3J5OiBzdHJpbmc7IGhlYWx0aFRyYWNrZXJGaWxlRGlyZWN0b3J5OiBzdHJpbmcgfSkge1xyXG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xyXG4gICAgICAgIHRoaXMuc2V0dGluZ3MgPSBzZXR0aW5ncztcclxuICAgIH1cclxuXHJcbiAgICAvL0RlZmF1bHQgbGlzdCBvZiBtdXNjbGUgZ3JvdXBzICh1c2VkIG9ubHkgaWYgdGhlcmUgaXMgbm8gcHJldmlvdXMgdGFibGUpXHJcbiAgICBwcml2YXRlIGRlZmF1bHRNdXNjbGVHcm91cHMgPSBbXCJHbHV0ZXNcIiwgXCJMZWdzXCIsIFwiQmFja1wiLCBcIkJyaXN0c1wiLCBcIlNob3VsZGVyc1wiLCBcIkpvZ2dpbmdcIiwgXCJZb2dhXCJdO1xyXG5cclxuICAgIC8vIEdldCB0aGUgZm9sZGVyIG5hbWUgYnkgbW9udGhcclxuICAgIHByaXZhdGUgZ2V0RmlsZU5hbWVCeU1vbnRoKGRhdGU6IERhdGUpOiBzdHJpbmcge1xyXG4gICAgICAgIGNvbnN0IG1vbnRoRGF0YSA9IGRhdGUudG9Mb2NhbGVEYXRlU3RyaW5nKFwiZW4tR0JcIiwgeyBtb250aDogXCJsb25nXCIgfSk7XHJcbiAgICAgICAgcmV0dXJuIGDwn5OFICR7bW9udGhEYXRhfWA7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gR2V0IHRoZSBmaWxlIG5hbWUgYnkgd2Vla1xyXG4gICAgcHJpdmF0ZSBnZXRGaWxlTmFtZUJ5V2VlayhkYXRlOiBEYXRlKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCBzdGFydE9mV2VlayA9IHRoaXMuZ2V0U3RhcnRPZldlZWsoZGF0ZSk7XHJcbiAgICAgICAgY29uc3QgZW5kT2ZXZWVrID0gbmV3IERhdGUoc3RhcnRPZldlZWspO1xyXG4gICAgICAgIGVuZE9mV2Vlay5zZXREYXRlKHN0YXJ0T2ZXZWVrLmdldERhdGUoKSArIDYpO1xyXG5cclxuICAgICAgICBjb25zdCBzdGFydERhdGUgPSBzdGFydE9mV2Vlay5nZXREYXRlKCk7XHJcbiAgICAgICAgY29uc3QgZW5kRGF0ZSA9IGVuZE9mV2Vlay5nZXREYXRlKCk7XHJcbiAgICAgICAgY29uc3Qgc3RhcnRNb250aCA9IHN0YXJ0T2ZXZWVrLnRvTG9jYWxlRGF0ZVN0cmluZyhcImVuLUdCXCIsIHsgbW9udGg6IFwic2hvcnRcIiB9KTtcclxuICAgICAgICBjb25zdCBlbmRNb250aCA9IGVuZE9mV2Vlay50b0xvY2FsZURhdGVTdHJpbmcoXCJlbi1HQlwiLCB7IG1vbnRoOiBcInNob3J0XCIgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBzdGFydE1vbnRoID09PSBlbmRNb250aFxyXG4gICAgICAgICAgICA/IGAke3N0YXJ0RGF0ZX0gLSAke2VuZERhdGV9Lm1kYFxyXG4gICAgICAgICAgICA6IGAke3N0YXJ0RGF0ZX0gJHtzdGFydE1vbnRofSAtICR7ZW5kRGF0ZX0gJHtlbmRNb250aH0ubWRgO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEdldCB0aGUgZnVsbCBmaWxlIHBhdGggYnkgZGF0ZVxyXG4gICAgcHVibGljIGdldEZpbGVQYXRoQnlEYXRlKGRhdGU6IERhdGUpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBgJHt0aGlzLnNldHRpbmdzLm1haW5GaWxlRGlyZWN0b3J5fS8ke3RoaXMuc2V0dGluZ3MuaGVhbHRoVHJhY2tlckZpbGVEaXJlY3Rvcnl9LyR7dGhpcy5nZXRGaWxlTmFtZUJ5TW9udGgoZGF0ZSl9LyR7dGhpcy5nZXRGaWxlTmFtZUJ5V2VlayhkYXRlKX1gO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENhbGN1bGF0ZSB0aGUgc3RhcnQgb2YgdGhlIHdlZWsgKE1vbmRheSlcclxuICAgIHByaXZhdGUgZ2V0U3RhcnRPZldlZWsoZGF0ZTogRGF0ZSk6IERhdGUge1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0T2ZXZWVrID0gbmV3IERhdGUoZGF0ZSk7XHJcbiAgICAgICAgY29uc3QgZGF5ID0gc3RhcnRPZldlZWsuZ2V0RGF5KCk7IC8vIFN1bmRheSA9IDAsIE1vbmRheSA9IDEsIC4uLlxyXG4gICAgICAgIGNvbnN0IG9mZnNldCA9IGRheSA9PT0gMCA/IDYgOiBkYXkgLSAxOyAvLyBBZGp1c3QgZm9yIE1vbmRheSBzdGFydFxyXG4gICAgICAgIHN0YXJ0T2ZXZWVrLnNldERhdGUoc3RhcnRPZldlZWsuZ2V0RGF0ZSgpIC0gb2Zmc2V0KTtcclxuICAgICAgICBzdGFydE9mV2Vlay5zZXRIb3VycygwLCAwLCAwLCAwKTsgLy8gUmVzZXQgdGltZSB0byBtaWRuaWdodFxyXG4gICAgICAgIHJldHVybiBzdGFydE9mV2VlaztcclxuICAgIH1cclxuXHJcbiAgICAvLyBFbnN1cmUgYWxsIHBhcmVudCBmb2xkZXJzIGV4aXN0XHJcbiAgICBwcml2YXRlIGFzeW5jIGVuc3VyZUZvbGRlcnNFeGlzdChmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgY29uc3QgZm9sZGVyUGF0aCA9IGZpbGVQYXRoLnN1YnN0cmluZygwLCBmaWxlUGF0aC5sYXN0SW5kZXhPZihcIi9cIikpO1xyXG4gICAgICAgIGxldCBmb2xkZXIgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZm9sZGVyUGF0aCkgYXMgVEZvbGRlciB8IG51bGw7XHJcblxyXG4gICAgICAgIGlmICghZm9sZGVyKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5jcmVhdGVGb2xkZXIoZm9sZGVyUGF0aCk7XHJcbiAgICAgICAgICAgICAgICBuZXcgTm90aWNlKGBDcmVhdGVkIGZvbGRlcjogJHtmb2xkZXJQYXRofWApO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGNyZWF0ZSBmb2xkZXIgJHtmb2xkZXJQYXRofTpgLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBjcmVhdGUgZm9sZGVyICR7Zm9sZGVyUGF0aH1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBOZXcgbWV0aG9kOiBFeHRyYWN0IG11c2NsZSBncm91cHMgZnJvbSB0aGUgcHJldmlvdXMgdGFibGVcclxuICAgIHByaXZhdGUgYXN5bmMgZ2V0UHJldmlvdXNNdXNjbGVHcm91cHMoY3VycmVudERhdGU6IERhdGUpOiBQcm9taXNlPHN0cmluZ1tdPiB7XHJcbiAgICAgICAgY29uc3QgcHJldmlvdXNXZWVrU3RhcnQgPSBuZXcgRGF0ZSh0aGlzLmdldFN0YXJ0T2ZXZWVrKGN1cnJlbnREYXRlKSk7XHJcbiAgICAgICAgcHJldmlvdXNXZWVrU3RhcnQuc2V0RGF0ZShwcmV2aW91c1dlZWtTdGFydC5nZXREYXRlKCkgLSA3KTsgLy8gU3dpdGNoIHRvIHRoZSBwcmV2aW91cyB3ZWVrXHJcblxyXG4gICAgICAgIGNvbnN0IHByZXZpb3VzUGF0aCA9IHRoaXMuZ2V0RmlsZVBhdGhCeURhdGUocHJldmlvdXNXZWVrU3RhcnQpO1xyXG4gICAgICAgIGNvbnN0IHByZXZpb3VzRmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChwcmV2aW91c1BhdGgpIGFzIFRGaWxlIHwgbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKCFwcmV2aW91c0ZpbGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKGBQcmV2aW91cyB3ZWVrIGZpbGUgbm90IGZvdW5kOiAke3ByZXZpb3VzUGF0aH0uIFVzaW5nIGRlZmF1bHQgbXVzY2xlIGdyb3Vwcy5gKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVmYXVsdE11c2NsZUdyb3VwcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkKHByZXZpb3VzRmlsZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpbmVzID0gY29udGVudC5zcGxpdChcIlxcblwiKTtcclxuXHJcbiAgICAgICAgICAgIC8vIEZpbmQgdGhlIHN0YXJ0IG9mIHRoZSB0YWJsZSAoYWZ0ZXIgXCJEYWlseSBIYWJpdHMgVHJhY2tcIikpXHJcbiAgICAgICAgICAgIGNvbnN0IHRhYmxlU3RhcnQgPSBsaW5lcy5maW5kSW5kZXgobGluZSA9PiBsaW5lLmluY2x1ZGVzKFwiRGFpbHkgSGFiaXRzIFRyYWNrXCIpKTtcclxuICAgICAgICAgICAgaWYgKHRhYmxlU3RhcnQgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZWZhdWx0TXVzY2xlR3JvdXBzOyAvLyBGYWxsYmFjayBpZiB0aGUgdGFibGUgaXMgY29ycnVwdGVkXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IG11c2NsZUdyb3Vwczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRhYmxlU3RhcnQgKyAxOyBpIDwgbGluZXMubGVuZ3RoICYmIGxpbmVzW2ldLnN0YXJ0c1dpdGgoXCJ8XCIpOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNlbGxzID0gbGluZXNbaV0uc3BsaXQoXCJ8XCIpLm1hcChjZWxsID0+IGNlbGwudHJpbSgpKTtcclxuICAgICAgICAgICAgICAgIGlmIChjZWxscy5sZW5ndGggPCAyKSBjb250aW51ZTtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBncm91cCA9IGNlbGxzWzFdO1xyXG4gICAgICAgICAgICAgICAgaWYgKGdyb3VwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbXVzY2xlR3JvdXBzLnB1c2goZ3JvdXApOyAvLyBFeHRyYWN0IHRoZSBtdXNjbGUgZ3JvdXAgZnJvbSB0aGUgc2Vjb25kIGNvbHVtblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbXVzY2xlR3JvdXBzLmxlbmd0aCA+IDAgPyBtdXNjbGVHcm91cHMgOiB0aGlzLmRlZmF1bHRNdXNjbGVHcm91cHM7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgcGFyc2luZyBwcmV2aW91cyB3ZWVrIGZpbGUgJHtwcmV2aW91c1BhdGh9OmAsIGVycm9yKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVmYXVsdE11c2NsZUdyb3VwczsgLy8gRmFsbGJhY2sgdG8gZGVmYXVsdFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBDcmVhdGUgYSBuZXcgd2Vla2x5IGhlYWx0aCB0cmFja2VyIGZpbGUgaWYgaXQgZG9lc24ndCBleGlzdFxyXG4gICAgYXN5bmMgY3JlYXRlV2Vla2x5RmlsZSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSB0aGlzLmdldEZpbGVQYXRoQnlEYXRlKHRvZGF5KTtcclxuICAgICAgICBhd2FpdCBlbnN1cmVGb2xkZXJzRXhpc3QodGhpcy5hcHAsIGZpbGVQYXRoKTtcclxuICAgICAgICBsZXQgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmaWxlUGF0aCkgYXMgVEZpbGUgfCBudWxsO1xyXG5cclxuICAgICAgICBpZiAoZmlsZSkge1xyXG4gICAgICAgICAgICByZXR1cm47IC8vIEZpbGUgYWxyZWFkeSBleGlzdHMsIGRvIG5vdGhpbmdcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEVuc3VyZSBwYXJlbnQgZm9sZGVycyBleGlzdFxyXG4gICAgICAgIGF3YWl0IHRoaXMuZW5zdXJlRm9sZGVyc0V4aXN0KGZpbGVQYXRoKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc3RhcnRPZldlZWsgPSB0aGlzLmdldFN0YXJ0T2ZXZWVrKHRvZGF5KTtcclxuICAgICAgICBjb25zdCBkYXlzT2ZXZWVrID0gW1wiTW9cIiwgXCJUdVwiLCBcIldlXCIsIFwiVGhcIiwgXCJGclwiLCBcIlNhXCIsIFwiU3VcIl07XHJcbiAgICAgICAgY29uc3QgZGF0ZXM6IHsgZGF5OiBudW1iZXI7IG1vbnRoOiBzdHJpbmcgfVtdID0gW107XHJcblxyXG4gICAgICAgIC8vIENvbGxlY3QgZGF0ZXMgYW5kIG1vbnRocyBmb3IgdGhlIHdlZWtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDc7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50ID0gbmV3IERhdGUoc3RhcnRPZldlZWspO1xyXG4gICAgICAgICAgICBjdXJyZW50LnNldERhdGUoc3RhcnRPZldlZWsuZ2V0RGF0ZSgpICsgaSk7XHJcbiAgICAgICAgICAgIGRhdGVzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgZGF5OiBjdXJyZW50LmdldERhdGUoKSxcclxuICAgICAgICAgICAgICAgIG1vbnRoOiBjdXJyZW50LnRvTG9jYWxlRGF0ZVN0cmluZyhcImVuLUdCXCIsIHsgbW9udGg6IFwic2hvcnRcIiB9KSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBPYnRhaW4gYSBkeW5hbWljIGxpc3Qgb2YgbXVzY2xlIGdyb3VwcyBmcm9tIHRoZSBwcmV2aW91cyB3ZWVrXHJcbiAgICAgICAgY29uc3QgbXVzY2xlR3JvdXBzID0gYXdhaXQgdGhpcy5nZXRQcmV2aW91c011c2NsZUdyb3Vwcyh0b2RheSk7XHJcblxyXG4gICAgICAgIC8vIEJ1aWxkIHRhYmxlIGNvbnRlbnRcclxuICAgICAgICBsZXQgY29udGVudCA9IGAjIEhlYWx0aCBUcmFja2VyIC0gJHt0b2RheS50b0xvY2FsZURhdGVTdHJpbmcoXCJlbi1HQlwiKX1cXG5cXG5gO1xyXG4gICAgICAgIGNvbnRlbnQgKz0gXCJ8IFdlZWtkYXlzICAgICAgICAgICB8IFwiICsgZGF5c09mV2Vlay5qb2luKFwiIHwgXCIpICsgXCIgfFxcblwiO1xyXG4gICAgICAgIGNvbnRlbnQgKz0gXCJ8IC0tLS0tLS0tLS0tLS0tLS0tLSB8XCIgKyBcIiAtLS0gfFwiLnJlcGVhdCg3KSArIFwiXFxuXCI7XHJcbiAgICAgICAgY29udGVudCArPSBcInwgRGFpbHkgSGFiaXRzIFRyYWNrIHwgXCIgKyBkYXRlcy5tYXAoZCA9PiBgJHtkLmRheX0gJHtkLm1vbnRofWApLmpvaW4oXCIgfCBcIikgKyBcIiB8XFxuXCI7XHJcblxyXG4gICAgICAgIC8vIGlkIEdlbmVyYXRvclxyXG4gICAgICAgIGZ1bmN0aW9uIGdlbmVyYXRlSWQoKTogc3RyaW5nIHtcclxuICAgICAgICAgICAgY29uc3QgY2hhcnMgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODknO1xyXG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gJyc7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgKz0gY2hhcnMuY2hhckF0KE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGNoYXJzLmxlbmd0aCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIG11c2NsZUdyb3Vwcykge1xyXG4gICAgICAgICAgICBjb250ZW50ICs9IGB8ICR7Z3JvdXAucGFkRW5kKDE4KX0gfCBgICsgZGF5c09mV2Vlay5tYXAoKCkgPT4gYDxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIiB1bmNoZWNrZWQgaWQ9XCIke2dlbmVyYXRlSWQoKX1cIj5gKS5qb2luKFwiIHwgXCIpICsgXCIgfFxcblwiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgZmlsZSA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZShmaWxlUGF0aCwgY29udGVudCk7XHJcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoYEZpbGUgXCIke2ZpbGUubmFtZX1cIiBjcmVhdGVkIWApO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBjcmVhdGUgZmlsZSAke2ZpbGVQYXRofTpgLCBlcnJvcik7XHJcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoYEVycm9yIGNyZWF0aW5nIGZpbGUgXCIke2ZpbGVQYXRofVwiYCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIEdldCBzdW1tYXJ5IG9mIGNvbXBsZXRlZCBhY3Rpdml0aWVzIGZvciB0aGUgY3VycmVudCB3ZWVrXHJcbiAgICBhc3luYyBnZXRUaGlzV2Vla1N1bW1hcnkoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xyXG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5nZXRGaWxlUGF0aEJ5RGF0ZShuZXcgRGF0ZSgpKTtcclxuICAgICAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGZpbGVQYXRoKSBhcyBURmlsZSB8IG51bGw7XHJcbiAgICAgICAgY29uc3Qgc3VtbWFyeTogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICAgICAgaWYgKCFmaWxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbXCJObyBoZWFsdGggdHJhY2tlciBmaWxlIGZvdW5kIGZvciB0aGlzIHdlZWsuXCJdO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LnJlYWQoZmlsZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpbmVzID0gY29udGVudC5zcGxpdChcIlxcblwiKTtcclxuICAgICAgICAgICAgY29uc3QgZGF5c09mV2VlayA9IFtcIk1vbmRheVwiLCBcIlR1ZXNkYXlcIiwgXCJXZWRuZXNkYXlcIiwgXCJUaHVyc2RheVwiLCBcIkZyaWRheVwiLCBcIlNhdHVyZGF5XCIsIFwiU3VuZGF5XCJdO1xyXG5cclxuICAgICAgICAgICAgLy8gRHluYW1pY2FsbHkgZXh0cmFjdCBtdXNjbGUgZ3JvdXBzIGZyb20gdGhlIGN1cnJlbnQgdGFibGUgKGZvciBzdW1tYXJ5IHN0YXRpc3RpY3MpXHJcbiAgICAgICAgICAgIGNvbnN0IG11c2NsZUdyb3VwcyA9IGF3YWl0IHRoaXMuZ2V0UHJldmlvdXNNdXNjbGVHcm91cHMobmV3IERhdGUoKSk7IC8vIE9yIHBhcnNlIGZyb20gdGhlIGN1cnJlbnQgZmlsZVxyXG5cclxuICAgICAgICAgICAgLy8gRmluZCB0aGUgdGFibGUgc3RhcnQgKGFmdGVyIFwiRGFpbHkgSGFiaXRzIFRyYWNrXCIpXHJcbiAgICAgICAgICAgIGNvbnN0IHRhYmxlU3RhcnQgPSBsaW5lcy5maW5kSW5kZXgobGluZSA9PiBsaW5lLmluY2x1ZGVzKFwiRGFpbHkgSGFiaXRzIFRyYWNrXCIpKTtcclxuICAgICAgICAgICAgaWYgKHRhYmxlU3RhcnQgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gW1wiVGFibGUgbm90IGZvdW5kIGluIGZpbGUuXCJdO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBQYXJzZSBtdXNjbGUgZ3JvdXAgcm93c1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gdGFibGVTdGFydCArIDE7IGkgPCBsaW5lcy5sZW5ndGggJiYgbGluZXNbaV0uc3RhcnRzV2l0aChcInxcIik7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2VsbHMgPSBsaW5lc1tpXS5zcGxpdChcInxcIikubWFwKGNlbGwgPT4gY2VsbC50cmltKCkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNlbGxzLmxlbmd0aCA8IDkpIGNvbnRpbnVlOyAvLyBTa2lwIGludmFsaWQgcm93c1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gY2VsbHNbMV07XHJcbiAgICAgICAgICAgICAgICBpZiAoIW11c2NsZUdyb3Vwcy5pbmNsdWRlcyhncm91cC50cmltKCkpKSBjb250aW51ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBDaGVjayBlYWNoIGRheSAoY29sdW1ucyAyIHRvIDgpXHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMjsgaiA8PSA4OyBqKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2VsbHNbal0uaW5jbHVkZXMoXCLimJHvuI9cIikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3VtbWFyeS5wdXNoKGAke2dyb3VwLnRyaW0oKX0gb24gJHtkYXlzT2ZXZWVrW2ogLSAyXX1gKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBzdW1tYXJ5Lmxlbmd0aCA+IDAgPyBzdW1tYXJ5IDogW1wiTm8gY29tcGxldGVkIGFjdGl2aXRpZXMgdGhpcyB3ZWVrLlwiXTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciByZWFkaW5nIGZpbGUgJHtmaWxlUGF0aH06YCwgZXJyb3IpO1xyXG4gICAgICAgICAgICByZXR1cm4gW1wiRXJyb3IgcmV0cmlldmluZyBzdW1tYXJ5LlwiXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=